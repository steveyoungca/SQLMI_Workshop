(function () {
    'use strict';
    angular
        .module('cloudsandbox.studentportal')
        .controller('InstructorQuizController', InstructorQuizController);

    InstructorQuizController.$inject = ['$scope', '$rootScope', '$state', '$stateParams', '$window', '$location', '$sce', '$interval', '$timeout', 'notifier', 'DataService', '$http', 'appConstant', 'serviceEndpoint', 'adalAuthenticationService', 'ModalService', 'ngTableParams'];

    /// <summary>
    /// Controller for quiz and survey page.
    /// </summary>
    function InstructorQuizController($scope, $rootScope, $state, $stateParams, $window, $location, $sce, $interval, $timeout, notifier, DataService, $http, appConstant, serviceEndpoint, adalService, ModalService, ngTableParams) {
        
        // Declare a proxy to reference the hub.
        var hubConnection = $.connection.quizHub;

        if ($state.params.quizUid === null) {
            $state.go("main.home");
        }
        else {
            $http.get(appConstant.apiRoot + serviceEndpoint.poll + '?uid=' + $state.params.quizUid)
                .then(function (response) {
                    if (response.data === null) {
                        notifier.notifyError("Invalid Quiz");
                        $state.go("main.home");
                    }
                    else {
                        $scope.Quiz = response.data;
                        $scope.TotalQuestions = response.data.Questions.length;
                    }
                }, function () {
                    notifier.notifyError("Invalid URL");
                    $state.go("main.home");
                });

            var instructorGroupName = $state.params.quizUid + "Instructor";
            var attendeeGroupName = $state.params.quizUid + "Attendee";
        }

        $scope.InstructorView = "Lobby";
        var userName = "FunQuiz-Instructor";
        var totalParticipants = 0;
        var option1Answer = 0;
        var option2Answer = 0;
        var option3Answer = 0;
        var option4Answer = 0;

        // Create a function that the hub can call to broadcast messages.
        hubConnection.client.echo = function (echoType, connectionId, optionId) {
            if (echoType === 'answer') {
                $('#options').empty();
                optionId = parseInt(optionId);
                for (var j = 0; j < $scope.CurrentQuestion.Options.length; j++) {
                    if ($scope.CurrentQuestion.Options[j].Id === optionId) {
                        switch (j + 1) {
                            case 1: option1Answer++;
                                break;
                            case 2: option2Answer++;
                                break;
                            case 3: option3Answer++;
                                break;
                            case 4: option4Answer++;
                                break;
                        }
                    }
                }

                renderOptions();

                // Save the reponse to DB
                var funQuizResponse = {};
                var userResponse = [{ QuestionId: $scope.CurrentQuestion.Id, AnswerId: optionId }];
                funQuizResponse.PollId = $scope.Quiz.Id;
                funQuizResponse.Responses = userResponse;
                $http.post(appConstant.apiRoot + '/api/Response/SaveFunQuizResponse', funQuizResponse)
                    .then(function (response) {
                        console.log("1");
                    }, function () {
                        console.log("0");
                    });
            }
            else if (echoType === 'userJoined') {
                totalParticipants++;
                $('#participantsCount').empty();
                $('#participantsCount').append(totalParticipants);
            }
        };

        // Start the connection.
        $.connection.hub.start().done(function () {
            //Adding instructor to a Group
            hubConnection.server.joinInsturctorGroup(userName, instructorGroupName);

            // Start Quiz
            $scope.startQuiz = function () {
                $scope.CurrentQuestion = $scope.Quiz.Questions[0];
                $scope.CurrentQuestionnumber = 1;
                $scope.AttendeeQuestion = {};
                $scope.AttendeeQuestion.Id = $scope.Quiz.Id;
                $scope.AttendeeQuestion.Name = $scope.Quiz.Name;
                $scope.AttendeeQuestion.CurrentQuestion = $scope.CurrentQuestion;
                $scope.AttendeeQuestion.CurrentQuestionnumber = $scope.CurrentQuestionnumber;
                $scope.AttendeeQuestion.TotalQuestions = $scope.TotalQuestions;

                hubConnection.server.sendQuestion(userName, attendeeGroupName, $scope.AttendeeQuestion);

                $('#lobby').empty();
                $('#lobby').css("padding-top" , "0px");
                $('#nextButton').append('<a class="btn btn-circle green-meadow col=md-offset-11"><i class= "fa fa-arrow-right"></i>Next</a >');
                $('#question').append($scope.CurrentQuestionnumber + '. ' + $scope.CurrentQuestion.Question);
                renderOptions();
            };

            $("#nextButton").click(function () {
                $('#question').empty();
                $('#options').empty();
                option1Answer = 0;
                option2Answer = 0;
                option3Answer = 0;
                option4Answer = 0;
                
                if ($scope.TotalQuestions === $scope.CurrentQuestionnumber) {
                    $('#nextButton').empty();
                    $('#endPage').empty();
                    $('#endPage').append('<h3><strong>End of the Quiz!</strong></h3>');
                    hubConnection.server.endGame(attendeeGroupName);
                }
                else {
                    $scope.CurrentQuestion = $scope.Quiz.Questions[$scope.CurrentQuestionnumber];
                    $scope.CurrentQuestionnumber++;
                    $scope.AttendeeQuestion = {};
                    $scope.AttendeeQuestion.Id = $scope.Quiz.Id;
                    $scope.AttendeeQuestion.Name = $scope.Quiz.Name;
                    $scope.AttendeeQuestion.CurrentQuestion = $scope.CurrentQuestion;
                    $scope.AttendeeQuestion.CurrentQuestionnumber = $scope.CurrentQuestionnumber;
                    $scope.AttendeeQuestion.TotalQuestions = $scope.TotalQuestions;

                    hubConnection.server.sendQuestion(userName, attendeeGroupName, $scope.AttendeeQuestion);
                    $('#question').append($scope.CurrentQuestionnumber + '. ' + $scope.CurrentQuestion.Question);
                    renderOptions();
                }
            });
        });

        function renderOptions() {
            for (var i = 0; i < $scope.CurrentQuestion.Options.length; i++) {
                switch (i + 1) {
                    case 1: $('#options').append('<div class="col-md-5 col-md-offset-1" style="padding-bottom:25px;"><button class= "btn blue btn-block btn-outline" style = "height:60px;">' + $scope.CurrentQuestion.Options[i].Description + ' <span style="float:right;font-size:20px"><strong>' + option1Answer + '</strong></span></button></div>');
                        break;
                    case 2: $('#options').append('<div class="col-md-5" style="padding-bottom:25px;"><button class= "btn blue btn-block btn-outline" style = "height:60px;">' + $scope.CurrentQuestion.Options[i].Description + ' <span style="float:right;font-size:20px"><strong>' + option2Answer + '</strong></span></button></div>');
                        break;
                    case 3: $('#options').append('<div class="col-md-5 col-md-offset-1" style="padding-bottom:25px;"><button class= "btn blue btn-block btn-outline" style = "height:60px;">' + $scope.CurrentQuestion.Options[i].Description + ' <span style="float:right;font-size:20px"><strong>' + option3Answer + '</strong></span></button></div>');
                        break;
                    case 4: $('#options').append('<div class="col-md-5" style="padding-bottom:25px;"><button class= "btn blue btn-block btn-outline" style = "height:60px;">' + $scope.CurrentQuestion.Options[i].Description + ' <span style="float:right;font-size:20px"><strong>' + option4Answer + '</strong></span></button></div>');
                        break;
                }
            }
        }
    }
})();