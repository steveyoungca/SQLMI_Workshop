(function () {
    'use strict';
    angular
        .module('cloudsandbox.studentportal')
        .controller('AttendeeQuizController', AttendeeQuizController);

    AttendeeQuizController.$inject = ['$scope', '$rootScope', '$state', '$stateParams', '$window', '$location', '$sce', '$interval', '$timeout', 'notifier', 'DataService', '$http', 'appConstant', 'serviceEndpoint', 'adalAuthenticationService', 'ModalService', 'ngTableParams'];

    /// <summary>
    /// Controller for quiz and survey page.
    /// </summary>
    function AttendeeQuizController($scope, $rootScope, $state, $stateParams, $window, $location, $sce, $interval, $timeout, notifier, DataService, $http, appConstant, serviceEndpoint, adalService, ModalService, ngTableParams) {

        // Declare a proxy to reference the hub.
        var hubConnection = $.connection.quizHub;
        $scope.Quiz = {};

        if ($state.params.quizUid === null) {
            $state.go("main.home");
        }
        else {
            $http.get(appConstant.apiRoot + '/api/Poll/GetFunQuizByUid?uId=' + $state.params.quizUid + '&role=ATTENDEE')
                .then(function (response) {
                    if (response.data === null) {
                        notifier.notifyError("Invalid Quiz");
                        $state.go("main.home");
                    }
                    else {
                        $scope.Quiz = response.data;
                        var instructorGroupName = $scope.Quiz.Uid + "Instructor";
                        var attendeeGroupName = $scope.Quiz.Uid + "Attendee";

                        // Start the connection.
                        $.connection.hub.start().done(function () {

                            //Adding instructor to a Group
                            hubConnection.server.joinAttendeeGroup(userName, attendeeGroupName, instructorGroupName);

                            $('#options').on('click', 'input', function () {
                                // Selected an option
                                var optionId = $(this).attr("id");
                                $('#question').empty();
                                $('#options').empty();
                                $('#result').empty();
                                if (currentQuestionNumber === totalQuestions) {
                                    //Last Question
                                    $('#result').append('<h3><strong>Thanks For The Feedbacks!</strong></h3>');
                                }
                                else {
                                    $('#result').append('<h3><strong>Wait For The Next Question...</strong></h3>');
                                }

                                //Sending the answer to the instructor
                                hubConnection.server.sendAnswer(instructorGroupName, optionId);
                            });
                        });
                    }
                }, function () {
                    notifier.notifyError("Invalid URL");
                    $state.go("main.home");
                });
        }

        var userName = "FunQuiz-Attendee";
        var currentQuestionNumber = 0;
        var totalQuestions = 0;

        // Create a function that the hub can call to broadcast messages.
        hubConnection.client.echo = function (echoType, response) {
            $('#lobby').empty();
            $('#result').empty();
            $('#quizName').empty();
            $('#question').empty();
            $('#options').empty();

            if (echoType === 'endGame') {
                $('#result').empty();
                $('#result').append('<h3><strong>Thanks for the Feedbacks!</strong></h3>');
            }
            else {
                $('#question').append(response.CurrentQuestion.Question);
                currentQuestionNumber = response.CurrentQuestionnumber;
                totalQuestions = response.TotalQuestions;
                for (var i = 0; i < response.CurrentQuestion.Options.length; i++) {
                    if (i % 2 === 0) {
                        $('#options').append('<div class="col-md-5 col-md-offset-1" style="padding-bottom:25px;"><input class= "btn blue btn-block btn-outline" value = "' + response.CurrentQuestion.Options[i].Description + '" style = "height:60px;" id = "' + response.CurrentQuestion.Options[i].Id + '"/></div>');
                    }
                    else {
                        $('#options').append('<div class="col-md-5" style="padding-bottom:25px;"><input class= "btn blue btn-block btn-outline" value = "' + response.CurrentQuestion.Options[i].Description + '" style = "height:60px;" id = "' + response.CurrentQuestion.Options[i].Id + '"/></div>');
                    }
                }
            }
        };
    }
})();