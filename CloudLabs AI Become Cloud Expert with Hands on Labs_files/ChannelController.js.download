(function () {
    'use strict';
    angular
        .module('cloudsandbox.studentportal')
        .controller('ChannelController', ChannelController);

    ChannelController.$inject = ['$scope', '$rootScope', '$state', '$stateParams', '$window', '$location', '$sce', 'notifier', 'DataService', '$http', 'appConstant', 'serviceEndpoint','$timeout'];

    /// <summary>
    /// Controller for event detail and registration page.
    /// </summary>
    function ChannelController($scope, $rootScope, $state, $stateParams, $window, $location, $sce, notifier, DataService, $http, appConstant, serviceEndpoint, $timeout) {
        var vm = this;
        $window.scrollTo(0, 0);

        //Hack to show just ODLs. Related change is in rout-config as well
        //$scope.mode = 'All';
        $scope.mode = 'On Demand Labs';

        var selectedTestDriveBeforeRedirect = localStorage.getItem("selectedTestDrive");
        if (selectedTestDriveBeforeRedirect) {
            $state.go('main.testdrive', { testdriveId: selectedTestDriveBeforeRedirect });
        }
        else {
            $scope.ChannelUniqueName = $stateParams.channelUniqueName;
            var url = appConstant.apiRoot + serviceEndpoint.channel + '/GetAllUnderChannel/' + $stateParams.channelUniqueName;
            if ($stateParams.channelmode != null) {
                switch ($stateParams.channelmode.toLowerCase()) {
                    case 'webinars':
                        $scope.mode = 'Webinars';
                        url = url + '/Webinar';
                        break;
                    case 'ondemandlabs':
                        $scope.mode = 'On Demand Labs';
                        url = url + '/TestDrive';
                        break;
                    case 'events':
                        $scope.mode = 'Events';
                        url = url + '/Event';
                        break;
                    default:
                        $state.go('main.channel', { channelUniqueName: $scope.ChannelUniqueName });
                        notifier.notifyError('The requested url does not exist.');
                }

            }

            $http.get(url).then(function (response) {
                $scope.channelData = response.data;
                if ($scope.channelData.ChannelInfo != undefined && $scope.channelData.ChannelInfo != null) {
                    if ($scope.channelData.ChannelInfo.ChannelBannerText) {
                        $scope.constant.mainHeading = $scope.channelData.ChannelInfo.ChannelBannerText;
                    }

                    if ($stateParams.channelmode == null) {
                        switch ($scope.channelData.ChannelInfo.DefaultEntityTypeId) {
                            case 104: $scope.mode = 'Events'; break;
                            case 106: $scope.mode = 'On Demand Labs'; break;
                            case 107: $scope.mode = 'Webinars'; break;
                            default: $state.go('main.home');
                        }
                    }
                    

                    $scope.channelData.OnDemandLabsCount = $scope.channelData.OnDemandLabs.length + $scope.channelData.Webinars.length;
                    if (($scope.mode == 'All' || $scope.mode == 'Events') && response.data.Workshop != null) {
                        $scope.workshops = DataService.transformWorkshopEvents(response.data.Workshop);
                    }

                    if ($scope.mode == 'All' || $scope.mode == 'Webinars') {
                        addThumbnails();
                    }
                }
                else {
                    $state.go('main.home');
                }
            })
                .catch(function (ex) {
                    notifier.notifyError("The requested channel does not exist");
                    $state.go('main.home');
                });
        }

        $scope.parseTags = function (onDemandLab) {
            return onDemandLab.Tags.split(',');
        }

        function addThumbnails() {
            angular.forEach($scope.channelData.Webinars, function (webinar) {
                if (webinar.WebinarUrl.includes('vimeo'))
                {
                    $http.get("https://vimeo.com/api/oembed.json?url=" + webinar.WebinarUrl)
                        .then(function (response) {
                            webinar["ThumbnailUrl"] = response.data.thumbnail_url_with_play_button;
                        })
                }
                else if (webinar.WebinarUrl.includes('youtube'))
                {
                    webinar["ThumbnailUrl"] = "https://img.youtube.com/vi/" + DataService.getVideoId(webinar.WebinarUrl) + "/mqdefault.jpg";
                }
            });
        }

        vm.goToWorkshop = function (uniqueName) {
            var url = "/#/event?" + uniqueName;
            $window.open(url, '_self');
        };

        vm.goToWebinar = function (uniqueName) {
            var url = "/#/webinar/" + uniqueName;
            $window.open(url, '_self');
        };

        $timeout(function () {
            $rootScope.handleContentHeight();
        }, 500);
    }

})();